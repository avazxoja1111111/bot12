# Overview

This is a comprehensive Telegram educational testing bot for the "Kitobxon Kids" project, designed to conduct reading comprehension tests for children aged 7-14 in Uzbekistan. The bot provides user registration, test management, administrative panels, statistics tracking, and reporting capabilities. It supports role-based access control with super admins and regular admins, multilingual interface in Uzbek, and comprehensive data analytics for educational insights.

## Recent Changes (August 2025)
- **MAJOR REFACTOR COMPLETED**: Complete professional refactoring of main.py from 2000+ lines of problematic code
- **Zero LSP Errors**: All 100+ syntax errors, type issues, and import problems resolved  
- **Professional Architecture**: Implemented proper class-based design with DataManager, InputValidator, KeyboardBuilder, and DocumentGenerator
- **Error Handling**: Added comprehensive exception handling with custom exception classes
- **Code Quality**: Professional logging, proper type annotations, and async/await patterns throughout
- **Bot Status**: Successfully deployed and running (@Kitobxonkidsbot)
- **All Features Working**: Registration, testing, admin panel, statistics, and broadcasting fully operational
- **BROADCASTING ENHANCEMENT**: Enhanced broadcasting system to send messages to ALL users who have started the bot (not just registered users)
- **USER TRACKING**: Added bot_users.json file to track all users who interact with the bot for comprehensive broadcasting
- **KEYBOARD FIX**: Fixed IndexError in age keyboard generation function with proper row management
- **EXCEL REPORTS ENHANCEMENT**: Completely redesigned Excel reports with 3 comprehensive sheets:
  - Foydalanuvchilar: Complete user data with 13 columns including registration details, regional information, and status
  - Test Natijalari: Detailed test results with 15 columns including performance grades, color-coded scores, and timing data
  - Statistika: Summary statistics with comprehensive metrics and explanations
- **PROFESSIONAL FORMATTING**: Added professional styling with colors, borders, auto-adjusted columns, and conditional formatting based on performance levels

# User Preferences

Preferred communication style: Simple, everyday language.

# System Architecture

## Bot Framework and Core Architecture
- **Framework**: aiogram (Python Telegram Bot API wrapper) with async/await pattern
- **Architecture Pattern**: Event-driven monolithic design with FSM (Finite State Machine) for conversation flows
- **Deployment Model**: Single-file architecture (main.py) for simplified deployment and maintenance
- **Rationale**: aiogram provides robust async support and clean state management, while monolithic design reduces complexity and infrastructure requirements

## Data Storage and Persistence
- **Storage System**: JSON file-based persistence in `bot_data/` directory
- **Data Structure**:
  - `users.json` - User profiles with child/parent info, location, and registration data
  - `admins.json` - Admin roles and permissions with audit trails
  - `tests.json` - Question banks organized by age groups (7-10, 11-14)
  - `results.json` - Test completion records with detailed scoring
  - `statistics.json` - System analytics and regional performance metrics
  - `broadcasts.json` - Message broadcasting history and delivery tracking
- **Rationale**: File-based storage chosen for lightweight deployment, zero database dependencies, and easy backup/migration
- **Trade-offs**: Limited concurrent access but adequate for educational bot usage patterns

## State Management and User Flow Control
- **Implementation**: FSM using aiogram's StatesGroup classes for multi-step interactions
- **State Categories**: User registration flows, test-taking sessions, admin operations, and content management
- **Session Handling**: Context preservation across messages with automatic cleanup
- **Purpose**: Manages complex user interactions requiring persistent state between messages

## Role-Based Access Control System
- **Super Admin**: Complete system control including user management, admin appointments, test creation/deletion, broadcasting, and comprehensive reporting
- **Regular Admin**: Limited to test creation and user interface access
- **Regular User**: Test participation, profile management, and result viewing
- **Special Privileges**: Hardcoded admin IDs with elevated permissions
- **Security**: Role validation on all operations with comprehensive audit logging

## Document Generation and Reporting
- **Excel Reports**: User statistics, test results, and administrative data using openpyxl
- **PDF Reports**: Formatted reports using reportlab for professional documentation
- **Export Features**: Multiple format support for data analysis and record keeping
- **Graceful Degradation**: Optional dependencies with fallback text-based exports

## Regional Data Management
- **Geographic Coverage**: Comprehensive Uzbekistan regional and district mapping
- **Statistics Tracking**: Regional performance analytics and user distribution
- **Localization**: Uzbek language interface with regional-specific content
- **Data Structure**: Hierarchical organization by region > district > mahalla

# External Dependencies

## Core Bot Infrastructure
- **aiogram**: Primary Telegram Bot API framework for async bot operations
- **Python asyncio**: Event loop management for concurrent message handling

## Document Generation Libraries
- **openpyxl**: Excel file generation for administrative reports and data exports
- **reportlab**: PDF document creation for formatted reports and analytics
- **Both libraries**: Optional dependencies with graceful degradation if unavailable

## System Dependencies
- **JSON**: Built-in Python library for data serialization and file-based storage
- **datetime**: Timezone handling for Uzbekistan time (UTC+5)
- **uuid**: Unique identifier generation for tests and sessions
- **tempfile**: Temporary file handling for document generation
- **pathlib**: Modern file system path operations

## Telegram Integration
- **Bot Token**: Environment variable or hardcoded token for Telegram API access
- **Channel Integration**: "@Kitobxon_Kids" channel for content distribution
- **File Upload**: Support for document sharing and media handling