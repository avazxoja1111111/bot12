import logging
import asyncio
from aiogram import Bot, Dispatcher, F
from aiogram.types import (
    Message, KeyboardButton, ReplyKeyboardMarkup,
    ReplyKeyboardRemove
)
from aiogram.filters import CommandStart

# ğŸ”‘ Bot tokeningizni shu yerga yozing
BOT_TOKEN = "YOUR_BOT_TOKEN"

# ğŸ“Œ Adminlar ID'lari
ADMINS = [6578706277, 7853664401]

# ğŸ”§ Logging
logging.basicConfig(level=logging.INFO)

# ğŸ”§ Bot va Dispatcher
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# ğŸ”§ Foydalanuvchi ma'lumotlarini vaqtincha saqlash
user_data = {}

# ğŸ”§ Viloyatlar va tumanlar (namuna uchun qisqartirilgan)
viloyatlar = {
    "Toshkent": ["Chilonzor", "Shayxontohur", "Yunusobod"],
    "Samarqand": ["Samarqand shahar", "Urgut", "Bulungâ€˜ur"],
    "Fargâ€˜ona": ["Fargâ€˜ona shahar", "Margâ€˜ilon", "Qoâ€˜qon"]
}


# ğŸ“Œ START komandasi
@dp.message(CommandStart())
async def start_cmd(message: Message):
    kb = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="â˜ï¸ Telefon raqamni yuborish", request_contact=True)],
                  [KeyboardButton(text="ğŸ“š Loyiha haqida")]],
        resize_keyboard=True
    )
    await message.answer("ğŸ‘‹ Salom! 'Kitobxon Kids' loyihasiga xush kelibsiz!\n\nRoâ€˜yxatdan oâ€˜tish uchun telefon raqamingizni yuboring:", reply_markup=kb)


# ğŸ“Œ Telefon raqam qabul qilish
@dp.message(F.contact)
async def get_contact(message: Message):
    user_data[message.from_user.id] = {"phone": message.contact.phone_number}
    await message.answer("ğŸ‘¶ Bolaning ism-sharifini kiriting:", reply_markup=ReplyKeyboardRemove())


# ğŸ“Œ Bolaning ismi
@dp.message(F.text, ~F.text.lower().in_({"ğŸ“š loyiha haqida"}))
async def get_child_name(message: Message):
    uid = message.from_user.id
    if "child_name" not in user_data.get(uid, {}):
        user_data[uid]["child_name"] = message.text
        await message.answer("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ota-onaning ism-sharifini kiriting:")
    elif "parent_name" not in user_data[uid]:
        user_data[uid]["parent_name"] = message.text
        kb = ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="7â€“10 yosh")],
                      [KeyboardButton(text="11â€“14 yosh")]],
            resize_keyboard=True
        )
        await message.answer("ğŸ“Œ Yosh toifasini tanlang:", reply_markup=kb)
    elif "age_group" not in user_data[uid]:
        user_data[uid]["age_group"] = message.text
        kb = ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text=v)] for v in viloyatlar.keys()] +
                    [[KeyboardButton(text="Qoâ€˜lda kiritish")]],
            resize_keyboard=True
        )
        await message.answer("ğŸ¢ Viloyatni tanlang yoki qoâ€˜lda kiriting:", reply_markup=kb)
    elif "region" not in user_data[uid]:
        if message.text == "Qoâ€˜lda kiritish":
            await message.answer("âœï¸ Viloyat nomini yozib kiriting:")
        else:
            user_data[uid]["region"] = message.text
            kb = ReplyKeyboardMarkup(
                keyboard=[[KeyboardButton(text=t)] for t in viloyatlar.get(message.text, [])] +
                        [[KeyboardButton(text="Qoâ€˜lda kiritish")]],
                resize_keyboard=True
            )
            await message.answer("ğŸ™ Tuman/Shaharni tanlang yoki qoâ€˜lda kiriting:", reply_markup=kb)
    elif "district" not in user_data[uid]:
        if message.text == "Qoâ€˜lda kiritish":
            await message.answer("âœï¸ Tuman/Shahar nomini yozib kiriting:")
        else:
            user_data[uid]["district"] = message.text
            await message.answer("ğŸ¡ Mahallangizni yozib kiriting:", reply_markup=ReplyKeyboardRemove())
    elif "neighborhood" not in user_data[uid]:
        user_data[uid]["neighborhood"] = message.text

        # âœ… Roâ€˜yxat tugadi
        data = user_data[uid]
        text = (f"âœ… Siz roâ€˜yxatdan muvaffaqiyatli oâ€˜tdingiz!\n\n"
                f"ğŸ‘¶ Bola: {data['child_name']}\n"
                f"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ota/Ona: {data['parent_name']}\n"
                f"ğŸ“ Telefon: {data['phone']}\n"
                f"ğŸ“Œ Yosh toifa: {data['age_group']}\n"
                f"ğŸ¢ Viloyat: {data.get('region', 'Nomaâ€™lum')}\n"
                f"ğŸ™ Tuman/Shahar: {data.get('district', 'Nomaâ€™lum')}\n"
                f"ğŸ¡ Mahalla: {data.get('neighborhood', 'Nomaâ€™lum')}")
        await message.answer(text)

        # Adminlarga yuborish
        for admin_id in ADMINS:
            try:
                await bot.send_message(admin_id, f"ğŸ“¥ Yangi roâ€˜yxatdan oâ€˜tuvchi:\n\n{text}")
            except:
                pass


# ğŸ“Œ "ğŸ“š Loyiha haqida"
@dp.message(F.text.lower() == "ğŸ“š loyiha haqida")
async def about_project(message: Message):
    await message.answer(
        "ğŸ“š *Kitobxon Kids* loyihasi haqida maâ€™lumot:\n\n"
        "ğŸ‘‰ Tanlov 7â€“10 va 11â€“14 yosh toifalari uchun.\n"
        "ğŸ‘‰ Ishtirokchilar roâ€˜yxatdan oâ€˜tib, kitobxonlik boâ€˜yicha bellashadilar.\n"
        "ğŸ‘‰ Qoâ€˜shimcha nizom va qoidalar adminlar tomonidan yuboriladi.",
        parse_mode="Markdown", disable_web_page_preview=True
    )


# ğŸ”§ Botni ishga tushirish
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
