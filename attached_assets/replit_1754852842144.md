# Overview

This is a comprehensive Telegram bot application built using the aiogram framework for the "Kitobxon_Kids" project. The bot implements a complete educational testing system with three-tier role-based access control (Super Admin, Regular Admin, Regular User), user registration, test management, automatic certificate generation, and broadcasting capabilities. The system supports two age groups (7-10 and 11-14 years) for children's educational testing with 25 randomly generated questions per test session, sourced from multiple books with a one-minute time limit per question. High-scoring users (80%+) automatically receive personalized certificates.

# User Preferences

Preferred communication style: Simple, everyday language.
Timezone: All timestamps converted to Uzbekistan timezone (UTC+5) as requested.

# System Architecture

## Bot Framework
- **Framework**: aiogram (Python Telegram Bot API wrapper)
- **Architecture Pattern**: Event-driven with FSM (Finite State Machine) for state management
- **Rationale**: aiogram provides robust async support and clean state management for complex bot interactions
- **Implementation**: Single-file architecture as per requirements, with comprehensive functionality contained within main.py

## Data Storage
- **Primary Storage**: JSON file-based storage in `bot_data/` directory
- **Files Structure**: 
  - `users.json` for user registration data
  - `admins.json` for admin role management
  - `tests.json` for test questions organized by age groups
  - `results.json` for test completion records
  - `certificates.json` for certificate generation
  - `broadcasts.json` for message broadcasting
- **Rationale**: Simple file-based storage chosen for lightweight deployment and minimal infrastructure requirements
- **Trade-offs**: Limited scalability but sufficient for small to medium user bases, no external database dependencies

## State Management
- **Pattern**: FSM using aiogram's built-in state management
- **Implementation**: StatesGroup classes for different conversation flows (Registration, testing, admin operations)
- **Purpose**: Handles multi-step user interactions like registration processes and test-taking sessions

## User Interface
- **Keyboard Types**: 
  - ReplyKeyboardMarkup for main navigation
  - InlineKeyboardMarkup for interactive buttons and test answers
- **Menu Structure**: Hierarchical menu system with regional data organization for Uzbekistan
- **Localization**: Uzbek language interface with comprehensive regional/district data covering all provinces of Uzbekistan

## Role-Based Access Control
- **Super Admin Role**: 
  - Full system access (add/remove/promote admins)
  - Complete test management (add/delete tests for both age groups)
  - Enhanced reporting with separate PDF and Excel exports
  - View detailed admin lists with names and usernames
  - Broadcast messages to all registered users
  - Access certificate management system
- **Special Admin Privileges** (IDs: 6578706277, 7853664401):
  - View all admin and super admin information
  - Remove any admin or super admin (unlimited access)
  - Override standard admin hierarchy restrictions
- **Regular Admin Role**: 
  - Limited access (add tests only, view users)
  - Receive notifications for user activities
- **Regular User Role**: 
  - Must register before accessing tests
  - Take age-appropriate tests with time constraints
  - Automatically receive certificates for 80%+ scores
- **Authentication**: Telegram ID-based authentication with hardcoded super admin IDs

## Test Management System
- **Age Groups**: Two distinct categories (7-10 years, 11-14 years)
- **Question Format**: Multiple choice with 4 options (A, B, C, D)
- **Content Types**: Support for both text-based and PDF-based test addition
- **Random Generation**: 25 questions randomly selected from available pool
- **Time Constraints**: One minute per question with automatic progression
- **Source Requirements**: Questions sourced from 5 different books per test session

## Document Generation
- **PDF Generation**: ReportLab library for creating formatted reports in landscape format
- **Excel Export**: openpyxl library for spreadsheet generation with auto-sizing and text wrapping
- **Features**: No data truncation, comprehensive formatting, temporary file handling
- **File Handling**: BufferedInputFile for document downloads through Telegram

## Certificate System
- **Automatic Generation**: Users scoring 70%+ on tests automatically receive certificates
- **Personalized Certificates**: Generated using child's full name (first + last name) from registration data
- **Custom Template Support**: Super Admins can upload custom PDF certificate templates
- **Template Management**: System automatically uses uploaded templates or falls back to default design
- **PDF Format**: Professional certificate design with achievement details
- **Storage**: Certificate data tracked in certificates.json file
- **Template Notifications**: All admins receive notifications when new templates are uploaded

## Notification System
- **Real-time Notifications**: All admins receive instant notifications for:
  - New user registrations
  - User feedback submissions
  - Test completion events
  - Admin role changes and promotions
  - Certificate generation for high-scoring users
- **Broadcast System**: Super Admin capability to send messages to all registered users
- **Certificate Delivery**: Automatic certificate delivery to qualifying users

## Statistics and Monitoring System
- **Real-time Analytics**: Comprehensive statistics covering all of Uzbekistan
- **Regional Breakdown**: User registration data by all provinces and districts
- **Performance Metrics**: Test completion rates, average scores, high achievers (70%+)
- **Age Group Analysis**: Separate statistics for 7-10 and 11-14 age categories
- **Automated Updates**: Statistics refresh automatically after each test completion
- **Super Admin Access**: Exclusive access to monitoring dashboard and rankings

## Rankings and Leaderboards
- **Top Performers**: Real-time ranking of highest-scoring participants
- **Regional Competition**: Province-wise user registration rankings
- **Medal System**: Gold, silver, bronze recognition for top performers
- **Comprehensive Data**: Includes names, scores, ages, regions, and completion dates
- **Privacy Compliant**: Uses child names from registration (as specified)
- **Limited Access**: Only Super Admins can view complete rankings and statistics

# External Dependencies

## Core Bot Framework
- **aiogram**: Modern Python Telegram Bot API framework with async support
- **asyncio**: Asynchronous programming support for concurrent operations

## Document Processing
- **reportlab**: PDF generation library for creating formatted reports and certificates
- **openpyxl**: Excel file generation and manipulation library
- **PyPDF2**: PDF file reading and processing for test content extraction

## Data Handling
- **json**: Built-in Python library for JSON file operations
- **uuid**: Unique identifier generation for tests and sessions
- **datetime/timedelta**: Date and time handling for timestamps and test timing

## Telegram Channel Integration
- **Channel**: @Kitobxon_Kids for mandatory subscription verification
- **Purpose**: Users must subscribe to the channel before accessing bot features

## Environment Configuration
- **BOT_TOKEN**: Updated token (6831189979:AAE-ZdVwdB34sMzg8Kot3PCCHdsFcUAlVoM) for @PppnewtestBot
- **SUPER_ADMIN_ID**: Primary super admin ID (6578706277) 
- **SPECIAL_ADMIN_IDS**: Two privileged admin accounts (6578706277, 7853664401) with override capabilities
- **File System**: Local directory structure with expanded data files:
  - users.json: User registration data
  - admins.json: Admin hierarchy and roles
  - tests.json: Test questions by age groups
  - results.json: Test completion records
  - certificates.json: Certificate generation tracking
  - broadcasts.json: Message broadcasting history
  - statistics.json: Real-time analytics and monitoring data
  - certificate_template.pdf: Custom certificate template (when uploaded)