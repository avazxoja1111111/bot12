# Overview

The Kitobxon Kids Telegram Bot is an educational platform designed for Uzbek children aged 7-14 years. The bot facilitates user registration with detailed location information (region, district, mahalla), manages educational content through a quiz system, and provides administrative capabilities for user data management and export functionality.

# User Preferences

Preferred communication style: Simple, everyday language.

# Recent Changes

## 2025-08-17: Complete System Overhaul and Database Integration
- **Database Integration**: Successfully migrated from JSON file storage to PostgreSQL database
  - Created comprehensive database models (Users, Questions, TestResults, TestAnswers, Feedback, RegionData)
  - Implemented automatic migration from existing JSON files to database tables
  - Added DatabaseService with full CRUD operations and session management
  - Enhanced data persistence and scalability with proper relational structure
  - Integrated database operations throughout admin panel and user management systems
- **Enhanced Welcome Message**: Replaced plain registration text with creative, engaging welcome message featuring emojis, project benefits, and motivational content that encourages participation

- **Complete Test Management System**: Fully implemented comprehensive question management
  - Single question addition with step-by-step interactive process
  - Bulk question addition supporting multiple questions in one input
  - File upload support for txt, docx, and xlsx formats with intelligent parsing
  - Question deletion by age group and number selection
  - Complete question viewing with statistics and summaries
  - Support for standardized format: "1. Question? A) Option B) Option C) Option D) Option Javob: C"
  - Automatic format detection and parsing for both single and bulk inputs

- **Advanced PDF Export System**: Complete redesign with professional layout and formatting
  - Fixed critical index out of range errors in table generation
  - Added comprehensive project branding and title
  - Included detailed regional statistics and demographic breakdown
  - Resolved all data truncation issues - complete information display
  - Professional visual design with proper spacing, colors, and alternating row styles
  - Full user data table with all registration fields and test statistics
  - Enhanced error handling and robust table styling

- **File Processing Capabilities**: Full implementation of document parsing
  - Text file (.txt) processing with UTF-8 encoding support
  - Word document (.docx) parsing using python-docx library
  - Excel spreadsheet (.xlsx) reading with openpyxl integration
  - Intelligent question extraction with regex pattern matching
  - Error handling for missing libraries and file format validation
  - Temporary file management with automatic cleanup

- **Admin Panel Enhancements**: All administrative functions now fully operational
  - Question management with multiple input methods
  - User statistics and monitoring
  - Data export in multiple formats
  - Broadcast messaging system
  - Real-time test monitoring capabilities

# System Architecture

## Bot Framework
- **Framework**: aiogram (modern async Python Telegram Bot API framework)
- **Storage**: MemoryStorage for FSM (Finite State Machine) state management
- **Database**: PostgreSQL with SQLAlchemy ORM for persistent data storage
- **Language**: Pure Python implementation with database integration
- **Concurrency**: Async/await pattern for handling 10,000+ concurrent users

## State Management and Data Storage
- **FSM Implementation**: Uses aiogram's built-in state management for multi-step user registration flow
- **Primary Storage**: PostgreSQL database with SQLAlchemy ORM
  - `users` table: User registration and profile data with relationships
  - `questions` table: Educational quiz content organized by age groups
  - `test_results` table: Completed test data with detailed scoring
  - `test_answers` table: Individual question responses within tests
  - `feedbacks` table: User feedback and suggestions
  - `region_data` table: Hierarchical location data (regions → districts → mahallas)
- **Legacy Support**: JSON file fallback for migration and compatibility

## User Registration Flow
- **Multi-step Process**: Contact sharing → Child name → Parent name → Location selection → Age group
- **Location Hierarchy**: Three-tier system (Viloyat/Region → Tuman/District → Mahalla/Neighborhood)
- **Flexible Input**: Manual input options available at each step as fallback
- **Age Segmentation**: Two distinct age groups (7-10 years, 11-14 years) for content customization

## Quiz System
- **Age-appropriate Content**: Questions tailored to specific age groups
- **Multiple Choice Format**: Standard quiz structure with single correct answers
- **Educational Focus**: Questions cover Uzbek culture, history, literature, and geography

## Administrative Features
- **Multi-admin Support**: Role-based access through admin ID whitelist
- **Data Export**: Dual format support (Excel via openpyxl, PDF via reportlab)
- **User Management**: Complete user data overview and export capabilities

## Error Handling & Resilience
- **Graceful Degradation**: Optional imports for Excel/PDF libraries with fallback behavior
- **Logging**: Comprehensive logging system for debugging and monitoring
- **Input Validation**: Structured validation for user inputs and state transitions

# External Dependencies

## Core Bot Dependencies
- **aiogram**: Modern async Telegram Bot API framework
- **asyncio**: Python's built-in async programming support

## Data Export Libraries
- **openpyxl**: Excel file generation and formatting (optional import)
- **reportlab**: PDF document generation with table support (optional import)

## Environment Configuration
- **BOT_TOKEN**: Telegram Bot API token from environment variables
- **ADMIN_IDS**: Comma-separated list of admin user IDs

## Data Storage
- **File-based Storage**: JSON files for persistent data storage
- **No External Database**: Self-contained data management system

## Hosting Requirements
- **Free Hosting Compatible**: Designed for resource-constrained environments
- **Memory-efficient**: Uses MemoryStorage for temporary state management
- **Single File Deployment**: Minimal file structure for easy deployment